<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>SSPS4102Data Analytics in the Social Sciences</title>
    <meta charset="utf-8" />
    <meta name="author" content="Francesco Bailo" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <link href="libs/remark-css/default.css" rel="stylesheet" />
    <link href="libs/remark-css/default-fonts.css" rel="stylesheet" />
    <script src="libs/htmlwidgets/htmlwidgets.js"></script>
    <script src="libs/jquery/jquery.min.js"></script>
    <link href="libs/leaflet/leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet/leaflet.js"></script>
    <link href="libs/leafletfix/leafletfix.css" rel="stylesheet" />
    <script src="libs/proj4/proj4.min.js"></script>
    <script src="libs/Proj4Leaflet/proj4leaflet.js"></script>
    <link href="libs/rstudio_leaflet/rstudio_leaflet.css" rel="stylesheet" />
    <script src="libs/leaflet-binding/leaflet.js"></script>
    <script src="libs/leaflet-providers/leaflet-providers_1.9.0.js"></script>
    <script src="libs/leaflet-providers-plugin/leaflet-providers-plugin.js"></script>
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# SSPS4102</br>Data Analytics in the Social Sciences
]
.subtitle[
## Analysing spatial data
]
.author[
### Francesco Bailo
]
.institute[
### The University of Sydney
]
.date[
### Semester 1, 2023 (updated: 2023-01-27)
]

---


background-image: url(https://upload.wikimedia.org/wikipedia/en/6/6a/Logo_of_the_University_of_Sydney.svg)
background-size: 95%



---

# What is GIS

---
class: inverse, center, middle

# Spatial data 

---

## Vector and raster data

![](http://www.eo4geo.eu/wp-content/uploads/2020/11/GEOF_Basic-GIS-knowledge-vector-and-raster-data.png) 
*Source: Marijan Grgic, University of Zagreb, Faculty of Geodesy.*

---

## Vector

---

## Point

---

## Polygon

---

## Raster

---

## Projection

---

## Scale

---

# GIS software

ArcGIS (pro) and QGIS (free)

---
class: inverse, center, middle

# Lab

---

## Simple Features

&gt; **Simple Features** ... is a set of standards that specify a common storage and access model of geographic feature made of mostly two-dimensional geometries (point, line, polygon, multi-point, multi-line, etc.) used by geographic information systems. (Source: [Wikipedia](https://en.wikipedia.org/wiki/Simple_Features)).

In other words, you find the same functions across different implementations.

### The sf package for R

.pull-left[

.center[&lt;img src="https://user-images.githubusercontent.com/520851/34887433-ce1d130e-f7c6-11e7-83fc-d60ad4fae6bd.gif"/&gt;]

.center[https://r-spatial.github.io/sf/]

]

.pull-right[

* Represents simple features as records in a `data.frame` with a geometry list-column.
* Extensive access to functions for *confirmation* (e.g. `st_contains`), *operations* (e.g. `st_buffer`) and creation (e.g. `st_point`).
* Excellent integration with ggplot2 using `geom_sf`...

]

---

## The sf integration with ggplot: geom_sf





```r
ggplot(nc) +
  geom_sf(aes(fill = AREA))
```

&lt;img src="r-analysing-spatial-data_files/figure-html/unnamed-chunk-2-1.svg" width="100%" style="display: block; margin: auto;" /&gt;

---

## John Snow and the 1854 London's cholera outbreak

.center[&lt;img src="https://upload.wikimedia.org/wikipedia/en/3/30/Jon_Snow_Season_8.png"/ width="20%"&gt;]

.center[(Not this Jon Snow)]

---

## John Snow and the 1854 London's cholera outbreak

.center[&lt;img src="https://upload.wikimedia.org/wikipedia/commons/thumb/2/27/Snow-cholera-map-1.jpg/1092px-Snow-cholera-map-1.jpg" width="520"/&gt;]

*Original map made by John Snow in 1854. Source: [Wikipedia](https://commons.wikimedia.org/wiki/File:Snow-cholera-map-1.jpg)*

---

## Load data

Data files are in [this folder](https://github.com/fraba/SSPS4102/tree/master/data/SnowGIS). To download the entire folder as a compressed archived [click here](https://minhaskamal.github.io/DownGit/#/home?url=https://github.com/fraba/SSPS4102/tree/master/data/SnowGIS) for the compressed folder.


```r
# Load the required packages

require(tidyverse)

require(sf)

require(leaflet)

*# Path might be different on your computer!

Cholera_Deaths &lt;- 
  sf::read_sf("../data/SnowGIS/Cholera_Deaths.shp")

*# Same here

Pumps &lt;- 
  sf::read_sf("../data/SnowGIS/Pumps.shp")
```

---

Let's check the class of these two simple features (sf) spatial objects...


```r
class(Cholera_Deaths)
```

```
## [1] "sf"         "tbl_df"     "tbl"        "data.frame"
```

```r
class(Pumps)
```

```
## [1] "sf"         "tbl_df"     "tbl"        "data.frame"
```

---



```r
head(Cholera_Deaths)

*## Simple feature collection with 6 features and 2 fields
*## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 529308.7 ymin: 181006 xmax: 529336.7 ymax: 181031.4
## Projected CRS: OSGB36 / British National Grid
## # A tibble: 6 × 3
*##      Id Count            geometry
##   &lt;int&gt; &lt;int&gt;         &lt;POINT [m]&gt;
## 1     0     3 (529308.7 181031.4)
## 2     0     2 (529312.2 181025.2)
## 3     0     1 (529314.4 181020.3)
## 4     0     1 (529317.4 181014.3)
## 5     0     4 (529320.7 181007.9)
## 6     0     2   (529336.7 181006)
```


The simple feature (sf) object contains 6 features of type `POINT` with 2 data fields (`ID` and `Count`). 

Records can have multiple fields since they are geometric/geographic features combined with a `data.frame`.

---


```r
head(Cholera_Deaths)

## Simple feature collection with 6 features and 2 fields 
## Geometry type: POINT
## Dimension:     XY
## Bounding box:  xmin: 529308.7 ymin: 181006 xmax: 529336.7 ymax: 181031.4 
*## Projected CRS: OSGB36 / British National Grid
## # A tibble: 6 × 3
##      Id Count            geometry
##   &lt;int&gt; &lt;int&gt;         &lt;POINT [m]&gt;
## 1     0     3 (529308.7 181031.4)
## 2     0     2 (529312.2 181025.2)
## 3     0     1 (529314.4 181020.3)
## 4     0     1 (529317.4 181014.3)
## 5     0     4 (529320.7 181007.9)
## 6     0     2   (529336.7 181006)
```

Also important to notice is the projection. 98% of the times if something doesn't work or look right with your spatial analysis mapping is because of the projection of one of your records. 

In this case the data (being about London) is projected using the Coordinate Reference System (CRS) [OSGB36](https://epsg.io/27700) - which corresponds to the code 27700 in [EPSG registry](https://epsg.org/home.html). EPSG codes are particularly useful to know if you need to change the projection of your features with `sf::st_transform()`.  

---

You can quickly interactively visualise your data with [Leaflet for R](https://rstudio.github.io/leaflet/).


```r
leaflet::leaflet(Cholera_Deaths %&gt;%
                   sf::st_transform(4326)) %&gt;%
  leaflet::addTiles() %&gt;%
  leaflet::addCircles(radius = ~sqrt(Count) * 5)
```

<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-7aa94a520ad9e6a99d88" style="width:100%;height:400px;"></div>
<script type="application/json" data-for="htmlwidget-7aa94a520ad9e6a99d88">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addTiles","args":["https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",null,null,{"minZoom":0,"maxZoom":18,"tileSize":256,"subdomains":"abc","errorTileUrl":"","tms":false,"noWrap":false,"zoomOffset":0,"zoomReverse":false,"opacity":1,"zIndex":1,"detectRetina":false,"attribution":"&copy; <a href=\"https://openstreetmap.org\">OpenStreetMap<\/a> contributors, <a href=\"https://creativecommons.org/licenses/by-sa/2.0/\">CC-BY-SA<\/a>"}]},{"method":"addCircles","args":[[51.5134177058694,51.5133613932863,51.5133170424259,51.5132621231126,51.5132039701697,51.5131835455003,51.5133591802217,51.5133280289552,51.513322951312,51.5134266663495,51.513381182688,51.5134623359004,51.513215921971,51.5131694420451,51.5131164683637,51.5132396050767,51.5131644144961,51.5131781775687,51.5131111914135,51.5130554309952,51.5134413261631,51.5135924142571,51.5134023317615,51.5133795663096,51.5134107749641,51.5136414461524,51.5136934204029,51.5137448689987,51.5136760935773,51.5135896436725,51.5136630697282,51.5135023061781,51.5135825616642,51.5135413095999,51.513297537202,51.5132905190171,51.5130133268832,51.5129647531367,51.512893244441,51.5129641520586,51.5130248331661,51.5130266692432,51.512830955586,51.512884554451,51.5125264550183,51.5124652257006,51.5124281951763,51.5124146436846,51.5125095530052,51.5123779629706,51.5124468777166,51.5124910838012,51.5123735172189,51.5123394592708,51.512364136963,51.5123186526854,51.5125404126725,51.5126485936205,51.5126924037367,51.5129565427214,51.5127646720712,51.5127801287277,51.5127261756299,51.5126812147017,51.5129138875437,51.5130464107575,51.513073613379,51.5130871587634,51.5131217235154,51.5131870315248,51.5132144585199,51.5132493604791,51.5132712232743,51.5132999987802,51.5131594952538,51.513015900298,51.5129212566954,51.5128901208211,51.5128594907412,51.5128304341672,51.5127817068333,51.5127289888399,51.5128684834477,51.5127226958855,51.5126544110501,51.5127129173,51.5126151265834,51.5124909208833,51.5124489945736,51.5124646666565,51.5124131360445,51.5123580217647,51.5122714783085,51.5123550971712,51.511990963963,51.5120825324908,51.5120308369794,51.511969708495,51.5118815960818,51.5120498223056,51.5122501384565,51.5121617416249,51.5122122427971,51.5125727934674,51.5125753065247,51.5126717773192,51.5127265209568,51.512793745634,51.512845935348,51.5128794651331,51.5129387809918,51.5127652557464,51.5128439427987,51.5125320027153,51.5121976476803,51.512214727212,51.5131535511061,51.5130559972954,51.5131654210675,51.5130978168923,51.5132380734678,51.5132931068438,51.5133792201206,51.5134305912225,51.5134746427495,51.5134215858843,51.5135280909604,51.5134813742577,51.5135939609638,51.5132269002181,51.5131797856697,51.5131320278292,51.5130477955603,51.5130059763671,51.5128824985023,51.513269758593,51.5134585137533,51.5134312944875,51.5134020460579,51.5125929784921,51.5125846123384,51.512554523741,51.512520772804,51.5131371916881,51.5132280989467,51.5131523803949,51.5132575857199,51.5135441081643,51.5136261081496,51.5136371080886,51.5135240501284,51.5138194966937,51.5137237714445,51.5137037194288,51.5138308544158,51.5139154079602,51.5135966482894,51.5140320704821,51.5138912008451,51.5137575548997,51.5140647662569,51.5141461268979,51.5142009178652,51.5142299687013,51.5143186368468,51.5143770599449,51.5143572259474,51.5143820161792,51.5144016848607,51.5145215487301,51.5144974200422,51.5144724198198,51.5145042334263,51.5145458018628,51.5145612126068,51.514593852717,51.5145811237021,51.5146055419353,51.5158344857054,51.5151947702909,51.5151489036039,51.5148182697654,51.5148434775857,51.5149136843145,51.5144955195607,51.5147432468027,51.5144670278464,51.5144530510451,51.514844669782,51.5143888063766,51.5143992360491,51.5143350480896,51.5142241873087,51.5142200430612,51.5141451546304,51.5141081134824,51.5143589852811,51.514325821291,51.5145439287095,51.5145694033154,51.5145860519543,51.5146119954611,51.5145748865566,51.5145068856862,51.5142738675189,51.5142925228525,51.5140584349534,51.514147898118,51.5139612829767,51.5140266753025,51.5140756186144,51.5140955435154,51.5141341899358,51.514033229154,51.5139963882004,51.5139599480527,51.5139447034083,51.5138209365821,51.5139986577674,51.513794927529,51.5137664444586,51.5137255249477,51.5136915588681,51.5136724363185,51.5136024979512,51.5134817429138,51.5134582068336,51.5134291879165,51.5134042474706,51.5133593150247,51.5133780348723,51.513854504874,51.5138745640831,51.5135649163926,51.5136161999742,51.5137422366559,51.5139182076963,51.5137723907512,51.5135021892142,51.5137121376888,51.5136438018585,51.5137110657696,51.5140612315785,51.5147479862845,51.514794257998,51.514526074558,51.5147058699104,51.5123109108084,51.5119984533651,51.5118557126788],[-0.137930062516868,-0.137883038556495,-0.137852868841468,-0.137811912453251,-0.137766784765802,-0.137536899921111,-0.138200436736303,-0.138044959687548,-0.138276108522369,-0.13822344494243,-0.138336995258361,-0.13856267118074,-0.138425554076643,-0.138378403710682,-0.138337109794586,-0.138645411881611,-0.138697865094891,-0.13792423943729,-0.137864870024444,-0.137811442062517,-0.138761881950736,-0.138798799971965,-0.139044644146919,-0.138969727757185,-0.138863382208082,-0.138752454492565,-0.138808117206398,-0.138855985083431,-0.138886823891262,-0.139239317363135,-0.139321231920396,-0.139315954531548,-0.13961591630383,-0.139719269517316,-0.140073770024927,-0.139093976742262,-0.139697151509883,-0.139327042200405,-0.139317346560676,-0.139186777885725,-0.139035899541791,-0.139209070842956,-0.138426968227262,-0.138624048329968,-0.138095697238992,-0.138034525040702,-0.137983516917512,-0.1380648201826,-0.138193731108201,-0.13781763909244,-0.137655835172851,-0.13758421009953,-0.137650266789236,-0.137449643911376,-0.137375918854288,-0.137327141569464,-0.136979853591122,-0.137180429620687,-0.137052215213775,-0.137695242488196,-0.137532926913325,-0.137418986407587,-0.137367644105141,-0.137324858943014,-0.137530679297059,-0.137561667879897,-0.137465921603165,-0.137386027650991,-0.137305863910066,-0.137088880290417,-0.136996466159705,-0.136858925562644,-0.136777590080392,-0.136705171796666,-0.136493500005924,-0.136329567820217,-0.136423512884086,-0.136523312581659,-0.136599423223285,-0.136698862408241,-0.136818567400955,-0.136972679490242,-0.136358480734612,-0.136629866421226,-0.136584379698206,-0.13642252133549,-0.136345059479243,-0.136437382169586,-0.136377214444993,-0.13619684420576,-0.136141523443039,-0.136101650362739,-0.136030156264047,-0.136309730202703,-0.135940377317568,-0.135857792381167,-0.135800029898829,-0.135716719988867,-0.135119158161977,-0.135144371878889,-0.135393837830499,-0.135409154831028,-0.13547206618057,-0.135765432983014,-0.135871255759463,-0.135975625674941,-0.136032860964593,-0.136115116334176,-0.136180207833462,-0.136082966300836,-0.136139409755494,-0.135328671328415,-0.135122053394763,-0.134644665837118,-0.134521502563546,-0.13496685089274,-0.135098092125846,-0.134393534010057,-0.134505206069689,-0.134436759305577,-0.134593561137141,-0.134640434830765,-0.134708643569606,-0.134756152192333,-0.135244342948288,-0.134897256145184,-0.135157886700703,-0.135344122827614,-0.135063339609602,-0.135800909025701,-0.135761568849939,-0.135740154137366,-0.135644897024836,-0.135601670609356,-0.135501338480465,-0.135832079767276,-0.1360487701935,-0.136139587613057,-0.13622778749438,-0.134999280257791,-0.134792903351678,-0.134896092799808,-0.134999916735448,-0.133482827684404,-0.133265179421733,-0.133296117603925,-0.132933478540891,-0.133998019591907,-0.13404186860326,-0.134156083936828,-0.13409122619745,-0.134272265560063,-0.134220238179037,-0.134704035956088,-0.134782290729799,-0.135010439104656,-0.134923165092386,-0.134884655890014,-0.134212333806906,-0.134135208967645,-0.134364142311478,-0.134446719769241,-0.13447936578885,-0.134657771885026,-0.13436724340823,-0.134178634377384,-0.13415976148722,-0.134068702044353,-0.134085124616283,-0.133821413071616,-0.133922274077607,-0.133849759892947,-0.133725256379654,-0.133745319871062,-0.13367571712426,-0.133563464723882,-0.133466513008693,-0.133392869832624,-0.134474118492023,-0.135258984205708,-0.135395298146342,-0.136022211489905,-0.136804075674203,-0.136583319096457,-0.135652932407312,-0.135577913854983,-0.134859609413001,-0.134689543246651,-0.134818231086368,-0.135703514844387,-0.135561310293036,-0.135648648672323,-0.135415144798746,-0.135576316345701,-0.13535663624528,-0.135475372149745,-0.136226072112923,-0.136328090679183,-0.136222106243106,-0.136117408087633,-0.136030284607007,-0.136266471337188,-0.13642132173871,-0.136934523829401,-0.136930770549059,-0.13679917559375,-0.136779562978219,-0.136695870341535,-0.136712157619842,-0.136123198402845,-0.135958276420819,-0.135882620118941,-0.135787674402964,-0.13584936711686,-0.136008180728894,-0.136098732339704,-0.136169566043722,-0.135485022374042,-0.13537399973136,-0.135581789145552,-0.135678984493575,-0.135814436267271,-0.135904558786079,-0.135992109203424,-0.13621682526215,-0.136578705632134,-0.136675042507504,-0.136764306667529,-0.136876931664,-0.136952907535882,-0.137230452303064,-0.136650505464377,-0.136502623183165,-0.137366549858923,-0.137421845905315,-0.137472214522456,-0.138300074439709,-0.137362623323104,-0.137995077953299,-0.138139217060626,-0.138239302539498,-0.138271775109572,-0.138082756406952,-0.137911641541603,-0.137707067954352,-0.137107699051381,-0.137064514887427,-0.138473500609749,-0.138123117837499,-0.137762106780764],[8.66025403784439,7.07106781186548,5,5,10,7.07106781186548,7.07106781186548,7.07106781186548,8.66025403784439,7.07106781186548,7.07106781186548,5,8.66025403784439,5,10,5,5,5,10,8.66025403784439,7.07106781186548,5,7.07106781186548,7.07106781186548,7.07106781186548,5,5,8.66025403784439,5,5,5,5,7.07106781186548,7.07106781186548,5,5,5,5,7.07106781186548,14.142135623731,7.07106781186548,5,5,5,5,5,10,5,5,5,5,10,5,5,5,5,5,7.07106781186548,5,5,5,7.07106781186548,5,5,7.07106781186548,7.07106781186548,5,7.07106781186548,8.66025403784439,5,10,19.3649167310371,8.66025403784439,10,11.1803398874989,7.07106781186548,5,7.07106781186548,5,5,5,5,5,5,5,5,5,5,5,5,5,7.07106781186548,5,5,10,7.07106781186548,5,10,10,5,10,5,5,7.07106781186548,5,7.07106781186548,8.66025403784439,5,10,5,5,13.228756555323,8.66025403784439,14.142135623731,5,5,11.1803398874989,14.142135623731,7.07106781186548,5,5,7.07106781186548,5,7.07106781186548,7.07106781186548,8.66025403784439,5,7.07106781186548,7.07106781186548,8.66025403784439,5,7.07106781186548,5,5,5,5,8.66025403784439,8.66025403784439,8.66025403784439,8.66025403784439,5,7.07106781186548,5,5,5,7.07106781186548,5,5,5,7.07106781186548,7.07106781186548,5,5,5,5,5,5,5,11.1803398874989,5,5,7.07106781186548,7.07106781186548,5,5,5,5,7.07106781186548,7.07106781186548,11.1803398874989,5,5,5,5,10,5,7.07106781186548,5,5,5,5,5,8.66025403784439,5,5,7.07106781186548,5,5,5,5,5,7.07106781186548,5,5,7.07106781186548,8.66025403784439,7.07106781186548,5,5,5,5,5,7.07106781186548,8.66025403784439,8.66025403784439,5,5,8.66025403784439,5,5,5,5,7.07106781186548,7.07106781186548,10,11.1803398874989,7.07106781186548,11.1803398874989,11.1803398874989,8.66025403784439,8.66025403784439,5,11.1803398874989,10,10,5,10,5,8.66025403784439,7.07106781186548,5,7.07106781186548,5,5,7.07106781186548,8.66025403784439,5,5,10,7.07106781186548,7.07106781186548,5,11.1803398874989,8.66025403784439,7.07106781186548,8.66025403784439,7.07106781186548,5,5,5],null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null,null]}],"limits":{"lat":[51.5118557126788,51.5158344857054],"lng":[-0.140073770024927,-0.132933478540891]}},"evals":[],"jsHooks":[]}</script>

---

Note, the transformation to [EPSG:4326](https://epsg.io/4326) which is the reference/coordinate system (a.k.a *WGS-84*) used by GPS, which is therefore used by most web mapping application like **Google Maps** or **OpenStreetMap** (which we are using here...)


```r
leaflet::leaflet(Cholera_Deaths %&gt;%
*                  sf::st_transform(4326)) %&gt;%
  leaflet::addTiles() %&gt;%
  leaflet::addCircles(radius = ~sqrt(Count) * 5)
```


---

`leaflet::addTiles()` add a background tile. By default it will use an OSM tile (this is why you need to transform your features to EPSG:4326). 


```r
leaflet::leaflet(Cholera_Deaths %&gt;%
                   sf::st_transform(4326)) %&gt;% 
* leaflet::addTiles() %&gt;%
  leaflet::addCircles(radius = ~sqrt(Count) * 5)
```

But there is a long list of different third-party tiles you can use for your maps (free of charge). A complete list is available [here](http://leaflet-extras.github.io/leaflet-providers/preview/index.html). 

For example replacing `addTiles()` with `addProviderTiles(providers$CartoDB.PositronNoLabels)` will produce 

<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-33fd0a801b402f811023" style="width:100%;height:200px;"></div>
<script type="application/json" data-for="htmlwidget-33fd0a801b402f811023">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["CartoDB.PositronNoLabels",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]},{"method":"addCircles","args":[[51.5134177058694,51.5133613932863,51.5133170424259,51.5132621231126,51.5132039701697,51.5131835455003,51.5133591802217,51.5133280289552,51.513322951312,51.5134266663495,51.513381182688,51.5134623359004,51.513215921971,51.5131694420451,51.5131164683637,51.5132396050767,51.5131644144961,51.5131781775687,51.5131111914135,51.5130554309952,51.5134413261631,51.5135924142571,51.5134023317615,51.5133795663096,51.5134107749641,51.5136414461524,51.5136934204029,51.5137448689987,51.5136760935773,51.5135896436725,51.5136630697282,51.5135023061781,51.5135825616642,51.5135413095999,51.513297537202,51.5132905190171,51.5130133268832,51.5129647531367,51.512893244441,51.5129641520586,51.5130248331661,51.5130266692432,51.512830955586,51.512884554451,51.5125264550183,51.5124652257006,51.5124281951763,51.5124146436846,51.5125095530052,51.5123779629706,51.5124468777166,51.5124910838012,51.5123735172189,51.5123394592708,51.512364136963,51.5123186526854,51.5125404126725,51.5126485936205,51.5126924037367,51.5129565427214,51.5127646720712,51.5127801287277,51.5127261756299,51.5126812147017,51.5129138875437,51.5130464107575,51.513073613379,51.5130871587634,51.5131217235154,51.5131870315248,51.5132144585199,51.5132493604791,51.5132712232743,51.5132999987802,51.5131594952538,51.513015900298,51.5129212566954,51.5128901208211,51.5128594907412,51.5128304341672,51.5127817068333,51.5127289888399,51.5128684834477,51.5127226958855,51.5126544110501,51.5127129173,51.5126151265834,51.5124909208833,51.5124489945736,51.5124646666565,51.5124131360445,51.5123580217647,51.5122714783085,51.5123550971712,51.511990963963,51.5120825324908,51.5120308369794,51.511969708495,51.5118815960818,51.5120498223056,51.5122501384565,51.5121617416249,51.5122122427971,51.5125727934674,51.5125753065247,51.5126717773192,51.5127265209568,51.512793745634,51.512845935348,51.5128794651331,51.5129387809918,51.5127652557464,51.5128439427987,51.5125320027153,51.5121976476803,51.512214727212,51.5131535511061,51.5130559972954,51.5131654210675,51.5130978168923,51.5132380734678,51.5132931068438,51.5133792201206,51.5134305912225,51.5134746427495,51.5134215858843,51.5135280909604,51.5134813742577,51.5135939609638,51.5132269002181,51.5131797856697,51.5131320278292,51.5130477955603,51.5130059763671,51.5128824985023,51.513269758593,51.5134585137533,51.5134312944875,51.5134020460579,51.5125929784921,51.5125846123384,51.512554523741,51.512520772804,51.5131371916881,51.5132280989467,51.5131523803949,51.5132575857199,51.5135441081643,51.5136261081496,51.5136371080886,51.5135240501284,51.5138194966937,51.5137237714445,51.5137037194288,51.5138308544158,51.5139154079602,51.5135966482894,51.5140320704821,51.5138912008451,51.5137575548997,51.5140647662569,51.5141461268979,51.5142009178652,51.5142299687013,51.5143186368468,51.5143770599449,51.5143572259474,51.5143820161792,51.5144016848607,51.5145215487301,51.5144974200422,51.5144724198198,51.5145042334263,51.5145458018628,51.5145612126068,51.514593852717,51.5145811237021,51.5146055419353,51.5158344857054,51.5151947702909,51.5151489036039,51.5148182697654,51.5148434775857,51.5149136843145,51.5144955195607,51.5147432468027,51.5144670278464,51.5144530510451,51.514844669782,51.5143888063766,51.5143992360491,51.5143350480896,51.5142241873087,51.5142200430612,51.5141451546304,51.5141081134824,51.5143589852811,51.514325821291,51.5145439287095,51.5145694033154,51.5145860519543,51.5146119954611,51.5145748865566,51.5145068856862,51.5142738675189,51.5142925228525,51.5140584349534,51.514147898118,51.5139612829767,51.5140266753025,51.5140756186144,51.5140955435154,51.5141341899358,51.514033229154,51.5139963882004,51.5139599480527,51.5139447034083,51.5138209365821,51.5139986577674,51.513794927529,51.5137664444586,51.5137255249477,51.5136915588681,51.5136724363185,51.5136024979512,51.5134817429138,51.5134582068336,51.5134291879165,51.5134042474706,51.5133593150247,51.5133780348723,51.513854504874,51.5138745640831,51.5135649163926,51.5136161999742,51.5137422366559,51.5139182076963,51.5137723907512,51.5135021892142,51.5137121376888,51.5136438018585,51.5137110657696,51.5140612315785,51.5147479862845,51.514794257998,51.514526074558,51.5147058699104,51.5123109108084,51.5119984533651,51.5118557126788],[-0.137930062516868,-0.137883038556495,-0.137852868841468,-0.137811912453251,-0.137766784765802,-0.137536899921111,-0.138200436736303,-0.138044959687548,-0.138276108522369,-0.13822344494243,-0.138336995258361,-0.13856267118074,-0.138425554076643,-0.138378403710682,-0.138337109794586,-0.138645411881611,-0.138697865094891,-0.13792423943729,-0.137864870024444,-0.137811442062517,-0.138761881950736,-0.138798799971965,-0.139044644146919,-0.138969727757185,-0.138863382208082,-0.138752454492565,-0.138808117206398,-0.138855985083431,-0.138886823891262,-0.139239317363135,-0.139321231920396,-0.139315954531548,-0.13961591630383,-0.139719269517316,-0.140073770024927,-0.139093976742262,-0.139697151509883,-0.139327042200405,-0.139317346560676,-0.139186777885725,-0.139035899541791,-0.139209070842956,-0.138426968227262,-0.138624048329968,-0.138095697238992,-0.138034525040702,-0.137983516917512,-0.1380648201826,-0.138193731108201,-0.13781763909244,-0.137655835172851,-0.13758421009953,-0.137650266789236,-0.137449643911376,-0.137375918854288,-0.137327141569464,-0.136979853591122,-0.137180429620687,-0.137052215213775,-0.137695242488196,-0.137532926913325,-0.137418986407587,-0.137367644105141,-0.137324858943014,-0.137530679297059,-0.137561667879897,-0.137465921603165,-0.137386027650991,-0.137305863910066,-0.137088880290417,-0.136996466159705,-0.136858925562644,-0.136777590080392,-0.136705171796666,-0.136493500005924,-0.136329567820217,-0.136423512884086,-0.136523312581659,-0.136599423223285,-0.136698862408241,-0.136818567400955,-0.136972679490242,-0.136358480734612,-0.136629866421226,-0.136584379698206,-0.13642252133549,-0.136345059479243,-0.136437382169586,-0.136377214444993,-0.13619684420576,-0.136141523443039,-0.136101650362739,-0.136030156264047,-0.136309730202703,-0.135940377317568,-0.135857792381167,-0.135800029898829,-0.135716719988867,-0.135119158161977,-0.135144371878889,-0.135393837830499,-0.135409154831028,-0.13547206618057,-0.135765432983014,-0.135871255759463,-0.135975625674941,-0.136032860964593,-0.136115116334176,-0.136180207833462,-0.136082966300836,-0.136139409755494,-0.135328671328415,-0.135122053394763,-0.134644665837118,-0.134521502563546,-0.13496685089274,-0.135098092125846,-0.134393534010057,-0.134505206069689,-0.134436759305577,-0.134593561137141,-0.134640434830765,-0.134708643569606,-0.134756152192333,-0.135244342948288,-0.134897256145184,-0.135157886700703,-0.135344122827614,-0.135063339609602,-0.135800909025701,-0.135761568849939,-0.135740154137366,-0.135644897024836,-0.135601670609356,-0.135501338480465,-0.135832079767276,-0.1360487701935,-0.136139587613057,-0.13622778749438,-0.134999280257791,-0.134792903351678,-0.134896092799808,-0.134999916735448,-0.133482827684404,-0.133265179421733,-0.133296117603925,-0.132933478540891,-0.133998019591907,-0.13404186860326,-0.134156083936828,-0.13409122619745,-0.134272265560063,-0.134220238179037,-0.134704035956088,-0.134782290729799,-0.135010439104656,-0.134923165092386,-0.134884655890014,-0.134212333806906,-0.134135208967645,-0.134364142311478,-0.134446719769241,-0.13447936578885,-0.134657771885026,-0.13436724340823,-0.134178634377384,-0.13415976148722,-0.134068702044353,-0.134085124616283,-0.133821413071616,-0.133922274077607,-0.133849759892947,-0.133725256379654,-0.133745319871062,-0.13367571712426,-0.133563464723882,-0.133466513008693,-0.133392869832624,-0.134474118492023,-0.135258984205708,-0.135395298146342,-0.136022211489905,-0.136804075674203,-0.136583319096457,-0.135652932407312,-0.135577913854983,-0.134859609413001,-0.134689543246651,-0.134818231086368,-0.135703514844387,-0.135561310293036,-0.135648648672323,-0.135415144798746,-0.135576316345701,-0.13535663624528,-0.135475372149745,-0.136226072112923,-0.136328090679183,-0.136222106243106,-0.136117408087633,-0.136030284607007,-0.136266471337188,-0.13642132173871,-0.136934523829401,-0.136930770549059,-0.13679917559375,-0.136779562978219,-0.136695870341535,-0.136712157619842,-0.136123198402845,-0.135958276420819,-0.135882620118941,-0.135787674402964,-0.13584936711686,-0.136008180728894,-0.136098732339704,-0.136169566043722,-0.135485022374042,-0.13537399973136,-0.135581789145552,-0.135678984493575,-0.135814436267271,-0.135904558786079,-0.135992109203424,-0.13621682526215,-0.136578705632134,-0.136675042507504,-0.136764306667529,-0.136876931664,-0.136952907535882,-0.137230452303064,-0.136650505464377,-0.136502623183165,-0.137366549858923,-0.137421845905315,-0.137472214522456,-0.138300074439709,-0.137362623323104,-0.137995077953299,-0.138139217060626,-0.138239302539498,-0.138271775109572,-0.138082756406952,-0.137911641541603,-0.137707067954352,-0.137107699051381,-0.137064514887427,-0.138473500609749,-0.138123117837499,-0.137762106780764],[8.66025403784439,7.07106781186548,5,5,10,7.07106781186548,7.07106781186548,7.07106781186548,8.66025403784439,7.07106781186548,7.07106781186548,5,8.66025403784439,5,10,5,5,5,10,8.66025403784439,7.07106781186548,5,7.07106781186548,7.07106781186548,7.07106781186548,5,5,8.66025403784439,5,5,5,5,7.07106781186548,7.07106781186548,5,5,5,5,7.07106781186548,14.142135623731,7.07106781186548,5,5,5,5,5,10,5,5,5,5,10,5,5,5,5,5,7.07106781186548,5,5,5,7.07106781186548,5,5,7.07106781186548,7.07106781186548,5,7.07106781186548,8.66025403784439,5,10,19.3649167310371,8.66025403784439,10,11.1803398874989,7.07106781186548,5,7.07106781186548,5,5,5,5,5,5,5,5,5,5,5,5,5,7.07106781186548,5,5,10,7.07106781186548,5,10,10,5,10,5,5,7.07106781186548,5,7.07106781186548,8.66025403784439,5,10,5,5,13.228756555323,8.66025403784439,14.142135623731,5,5,11.1803398874989,14.142135623731,7.07106781186548,5,5,7.07106781186548,5,7.07106781186548,7.07106781186548,8.66025403784439,5,7.07106781186548,7.07106781186548,8.66025403784439,5,7.07106781186548,5,5,5,5,8.66025403784439,8.66025403784439,8.66025403784439,8.66025403784439,5,7.07106781186548,5,5,5,7.07106781186548,5,5,5,7.07106781186548,7.07106781186548,5,5,5,5,5,5,5,11.1803398874989,5,5,7.07106781186548,7.07106781186548,5,5,5,5,7.07106781186548,7.07106781186548,11.1803398874989,5,5,5,5,10,5,7.07106781186548,5,5,5,5,5,8.66025403784439,5,5,7.07106781186548,5,5,5,5,5,7.07106781186548,5,5,7.07106781186548,8.66025403784439,7.07106781186548,5,5,5,5,5,7.07106781186548,8.66025403784439,8.66025403784439,5,5,8.66025403784439,5,5,5,5,7.07106781186548,7.07106781186548,10,11.1803398874989,7.07106781186548,11.1803398874989,11.1803398874989,8.66025403784439,8.66025403784439,5,11.1803398874989,10,10,5,10,5,8.66025403784439,7.07106781186548,5,7.07106781186548,5,5,7.07106781186548,8.66025403784439,5,5,10,7.07106781186548,7.07106781186548,5,11.1803398874989,8.66025403784439,7.07106781186548,8.66025403784439,7.07106781186548,5,5,5],null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null,null]}],"limits":{"lat":[51.5118557126788,51.5158344857054],"lng":[-0.140073770024927,-0.132933478540891]}},"evals":[],"jsHooks":[]}</script>

---

With `leaflet::addCircles()`, we add circles to the map. The features we are mapping are of course the features contained in the sf `Cholera_Deaths`. 

Specifically, `leaflet::leaflet(data)`, will create our map and the pipe `%&gt;%` will pass it down to the other functions, so that we can progressively (back-to-top) add new layers and new data. 

With  `radius` we specify the radius of the circles. Here, we are mapping the value from the column `Count` contained in the `data.frame` of `Cholera_Deaths` (this is similar to what happens in ggplot2's `aes()`).


```r
leaflet::leaflet(Cholera_Deaths %&gt;%
                   sf::st_transform(4326)) %&gt;% 
  leaflet::addTiles() %&gt;%
* leaflet::addCircles(radius = ~sqrt(Count) * 5)
```

---

Let's now add the pumps features. In this situation, I simply add a layer with `addMarkers()`. This of course is very much like how we add layers in ggplot2 😄. 


```r
leaflet::leaflet(Cholera_Deaths %&gt;%
                   sf::st_transform(4326)) %&gt;% 
  addProviderTiles(providers$Stamen.TonerLite) %&gt;%
  leaflet::addCircles(radius = ~sqrt(Count) * 5) %&gt;%
  leaflet::addMarkers(data = Pumps %&gt;%
                   sf::st_transform(4326))
```

<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-9d078f932b2ded79e980" style="width:100%;height:300px;"></div>
<script type="application/json" data-for="htmlwidget-9d078f932b2ded79e980">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["Stamen.TonerLite",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]},{"method":"addCircles","args":[[51.5134177058694,51.5133613932863,51.5133170424259,51.5132621231126,51.5132039701697,51.5131835455003,51.5133591802217,51.5133280289552,51.513322951312,51.5134266663495,51.513381182688,51.5134623359004,51.513215921971,51.5131694420451,51.5131164683637,51.5132396050767,51.5131644144961,51.5131781775687,51.5131111914135,51.5130554309952,51.5134413261631,51.5135924142571,51.5134023317615,51.5133795663096,51.5134107749641,51.5136414461524,51.5136934204029,51.5137448689987,51.5136760935773,51.5135896436725,51.5136630697282,51.5135023061781,51.5135825616642,51.5135413095999,51.513297537202,51.5132905190171,51.5130133268832,51.5129647531367,51.512893244441,51.5129641520586,51.5130248331661,51.5130266692432,51.512830955586,51.512884554451,51.5125264550183,51.5124652257006,51.5124281951763,51.5124146436846,51.5125095530052,51.5123779629706,51.5124468777166,51.5124910838012,51.5123735172189,51.5123394592708,51.512364136963,51.5123186526854,51.5125404126725,51.5126485936205,51.5126924037367,51.5129565427214,51.5127646720712,51.5127801287277,51.5127261756299,51.5126812147017,51.5129138875437,51.5130464107575,51.513073613379,51.5130871587634,51.5131217235154,51.5131870315248,51.5132144585199,51.5132493604791,51.5132712232743,51.5132999987802,51.5131594952538,51.513015900298,51.5129212566954,51.5128901208211,51.5128594907412,51.5128304341672,51.5127817068333,51.5127289888399,51.5128684834477,51.5127226958855,51.5126544110501,51.5127129173,51.5126151265834,51.5124909208833,51.5124489945736,51.5124646666565,51.5124131360445,51.5123580217647,51.5122714783085,51.5123550971712,51.511990963963,51.5120825324908,51.5120308369794,51.511969708495,51.5118815960818,51.5120498223056,51.5122501384565,51.5121617416249,51.5122122427971,51.5125727934674,51.5125753065247,51.5126717773192,51.5127265209568,51.512793745634,51.512845935348,51.5128794651331,51.5129387809918,51.5127652557464,51.5128439427987,51.5125320027153,51.5121976476803,51.512214727212,51.5131535511061,51.5130559972954,51.5131654210675,51.5130978168923,51.5132380734678,51.5132931068438,51.5133792201206,51.5134305912225,51.5134746427495,51.5134215858843,51.5135280909604,51.5134813742577,51.5135939609638,51.5132269002181,51.5131797856697,51.5131320278292,51.5130477955603,51.5130059763671,51.5128824985023,51.513269758593,51.5134585137533,51.5134312944875,51.5134020460579,51.5125929784921,51.5125846123384,51.512554523741,51.512520772804,51.5131371916881,51.5132280989467,51.5131523803949,51.5132575857199,51.5135441081643,51.5136261081496,51.5136371080886,51.5135240501284,51.5138194966937,51.5137237714445,51.5137037194288,51.5138308544158,51.5139154079602,51.5135966482894,51.5140320704821,51.5138912008451,51.5137575548997,51.5140647662569,51.5141461268979,51.5142009178652,51.5142299687013,51.5143186368468,51.5143770599449,51.5143572259474,51.5143820161792,51.5144016848607,51.5145215487301,51.5144974200422,51.5144724198198,51.5145042334263,51.5145458018628,51.5145612126068,51.514593852717,51.5145811237021,51.5146055419353,51.5158344857054,51.5151947702909,51.5151489036039,51.5148182697654,51.5148434775857,51.5149136843145,51.5144955195607,51.5147432468027,51.5144670278464,51.5144530510451,51.514844669782,51.5143888063766,51.5143992360491,51.5143350480896,51.5142241873087,51.5142200430612,51.5141451546304,51.5141081134824,51.5143589852811,51.514325821291,51.5145439287095,51.5145694033154,51.5145860519543,51.5146119954611,51.5145748865566,51.5145068856862,51.5142738675189,51.5142925228525,51.5140584349534,51.514147898118,51.5139612829767,51.5140266753025,51.5140756186144,51.5140955435154,51.5141341899358,51.514033229154,51.5139963882004,51.5139599480527,51.5139447034083,51.5138209365821,51.5139986577674,51.513794927529,51.5137664444586,51.5137255249477,51.5136915588681,51.5136724363185,51.5136024979512,51.5134817429138,51.5134582068336,51.5134291879165,51.5134042474706,51.5133593150247,51.5133780348723,51.513854504874,51.5138745640831,51.5135649163926,51.5136161999742,51.5137422366559,51.5139182076963,51.5137723907512,51.5135021892142,51.5137121376888,51.5136438018585,51.5137110657696,51.5140612315785,51.5147479862845,51.514794257998,51.514526074558,51.5147058699104,51.5123109108084,51.5119984533651,51.5118557126788],[-0.137930062516868,-0.137883038556495,-0.137852868841468,-0.137811912453251,-0.137766784765802,-0.137536899921111,-0.138200436736303,-0.138044959687548,-0.138276108522369,-0.13822344494243,-0.138336995258361,-0.13856267118074,-0.138425554076643,-0.138378403710682,-0.138337109794586,-0.138645411881611,-0.138697865094891,-0.13792423943729,-0.137864870024444,-0.137811442062517,-0.138761881950736,-0.138798799971965,-0.139044644146919,-0.138969727757185,-0.138863382208082,-0.138752454492565,-0.138808117206398,-0.138855985083431,-0.138886823891262,-0.139239317363135,-0.139321231920396,-0.139315954531548,-0.13961591630383,-0.139719269517316,-0.140073770024927,-0.139093976742262,-0.139697151509883,-0.139327042200405,-0.139317346560676,-0.139186777885725,-0.139035899541791,-0.139209070842956,-0.138426968227262,-0.138624048329968,-0.138095697238992,-0.138034525040702,-0.137983516917512,-0.1380648201826,-0.138193731108201,-0.13781763909244,-0.137655835172851,-0.13758421009953,-0.137650266789236,-0.137449643911376,-0.137375918854288,-0.137327141569464,-0.136979853591122,-0.137180429620687,-0.137052215213775,-0.137695242488196,-0.137532926913325,-0.137418986407587,-0.137367644105141,-0.137324858943014,-0.137530679297059,-0.137561667879897,-0.137465921603165,-0.137386027650991,-0.137305863910066,-0.137088880290417,-0.136996466159705,-0.136858925562644,-0.136777590080392,-0.136705171796666,-0.136493500005924,-0.136329567820217,-0.136423512884086,-0.136523312581659,-0.136599423223285,-0.136698862408241,-0.136818567400955,-0.136972679490242,-0.136358480734612,-0.136629866421226,-0.136584379698206,-0.13642252133549,-0.136345059479243,-0.136437382169586,-0.136377214444993,-0.13619684420576,-0.136141523443039,-0.136101650362739,-0.136030156264047,-0.136309730202703,-0.135940377317568,-0.135857792381167,-0.135800029898829,-0.135716719988867,-0.135119158161977,-0.135144371878889,-0.135393837830499,-0.135409154831028,-0.13547206618057,-0.135765432983014,-0.135871255759463,-0.135975625674941,-0.136032860964593,-0.136115116334176,-0.136180207833462,-0.136082966300836,-0.136139409755494,-0.135328671328415,-0.135122053394763,-0.134644665837118,-0.134521502563546,-0.13496685089274,-0.135098092125846,-0.134393534010057,-0.134505206069689,-0.134436759305577,-0.134593561137141,-0.134640434830765,-0.134708643569606,-0.134756152192333,-0.135244342948288,-0.134897256145184,-0.135157886700703,-0.135344122827614,-0.135063339609602,-0.135800909025701,-0.135761568849939,-0.135740154137366,-0.135644897024836,-0.135601670609356,-0.135501338480465,-0.135832079767276,-0.1360487701935,-0.136139587613057,-0.13622778749438,-0.134999280257791,-0.134792903351678,-0.134896092799808,-0.134999916735448,-0.133482827684404,-0.133265179421733,-0.133296117603925,-0.132933478540891,-0.133998019591907,-0.13404186860326,-0.134156083936828,-0.13409122619745,-0.134272265560063,-0.134220238179037,-0.134704035956088,-0.134782290729799,-0.135010439104656,-0.134923165092386,-0.134884655890014,-0.134212333806906,-0.134135208967645,-0.134364142311478,-0.134446719769241,-0.13447936578885,-0.134657771885026,-0.13436724340823,-0.134178634377384,-0.13415976148722,-0.134068702044353,-0.134085124616283,-0.133821413071616,-0.133922274077607,-0.133849759892947,-0.133725256379654,-0.133745319871062,-0.13367571712426,-0.133563464723882,-0.133466513008693,-0.133392869832624,-0.134474118492023,-0.135258984205708,-0.135395298146342,-0.136022211489905,-0.136804075674203,-0.136583319096457,-0.135652932407312,-0.135577913854983,-0.134859609413001,-0.134689543246651,-0.134818231086368,-0.135703514844387,-0.135561310293036,-0.135648648672323,-0.135415144798746,-0.135576316345701,-0.13535663624528,-0.135475372149745,-0.136226072112923,-0.136328090679183,-0.136222106243106,-0.136117408087633,-0.136030284607007,-0.136266471337188,-0.13642132173871,-0.136934523829401,-0.136930770549059,-0.13679917559375,-0.136779562978219,-0.136695870341535,-0.136712157619842,-0.136123198402845,-0.135958276420819,-0.135882620118941,-0.135787674402964,-0.13584936711686,-0.136008180728894,-0.136098732339704,-0.136169566043722,-0.135485022374042,-0.13537399973136,-0.135581789145552,-0.135678984493575,-0.135814436267271,-0.135904558786079,-0.135992109203424,-0.13621682526215,-0.136578705632134,-0.136675042507504,-0.136764306667529,-0.136876931664,-0.136952907535882,-0.137230452303064,-0.136650505464377,-0.136502623183165,-0.137366549858923,-0.137421845905315,-0.137472214522456,-0.138300074439709,-0.137362623323104,-0.137995077953299,-0.138139217060626,-0.138239302539498,-0.138271775109572,-0.138082756406952,-0.137911641541603,-0.137707067954352,-0.137107699051381,-0.137064514887427,-0.138473500609749,-0.138123117837499,-0.137762106780764],[8.66025403784439,7.07106781186548,5,5,10,7.07106781186548,7.07106781186548,7.07106781186548,8.66025403784439,7.07106781186548,7.07106781186548,5,8.66025403784439,5,10,5,5,5,10,8.66025403784439,7.07106781186548,5,7.07106781186548,7.07106781186548,7.07106781186548,5,5,8.66025403784439,5,5,5,5,7.07106781186548,7.07106781186548,5,5,5,5,7.07106781186548,14.142135623731,7.07106781186548,5,5,5,5,5,10,5,5,5,5,10,5,5,5,5,5,7.07106781186548,5,5,5,7.07106781186548,5,5,7.07106781186548,7.07106781186548,5,7.07106781186548,8.66025403784439,5,10,19.3649167310371,8.66025403784439,10,11.1803398874989,7.07106781186548,5,7.07106781186548,5,5,5,5,5,5,5,5,5,5,5,5,5,7.07106781186548,5,5,10,7.07106781186548,5,10,10,5,10,5,5,7.07106781186548,5,7.07106781186548,8.66025403784439,5,10,5,5,13.228756555323,8.66025403784439,14.142135623731,5,5,11.1803398874989,14.142135623731,7.07106781186548,5,5,7.07106781186548,5,7.07106781186548,7.07106781186548,8.66025403784439,5,7.07106781186548,7.07106781186548,8.66025403784439,5,7.07106781186548,5,5,5,5,8.66025403784439,8.66025403784439,8.66025403784439,8.66025403784439,5,7.07106781186548,5,5,5,7.07106781186548,5,5,5,7.07106781186548,7.07106781186548,5,5,5,5,5,5,5,11.1803398874989,5,5,7.07106781186548,7.07106781186548,5,5,5,5,7.07106781186548,7.07106781186548,11.1803398874989,5,5,5,5,10,5,7.07106781186548,5,5,5,5,5,8.66025403784439,5,5,7.07106781186548,5,5,5,5,5,7.07106781186548,5,5,7.07106781186548,8.66025403784439,7.07106781186548,5,5,5,5,5,7.07106781186548,8.66025403784439,8.66025403784439,5,5,8.66025403784439,5,5,5,5,7.07106781186548,7.07106781186548,10,11.1803398874989,7.07106781186548,11.1803398874989,11.1803398874989,8.66025403784439,8.66025403784439,5,11.1803398874989,10,10,5,10,5,8.66025403784439,7.07106781186548,5,7.07106781186548,5,5,7.07106781186548,8.66025403784439,5,5,10,7.07106781186548,7.07106781186548,5,11.1803398874989,8.66025403784439,7.07106781186548,8.66025403784439,7.07106781186548,5,5,5],null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null,null]},{"method":"addMarkers","args":[[51.5133411105774,51.5138759843636,51.5149055660644,51.512354016928,51.5121388725016,51.5115423119947,51.5100193414476,51.5112952195827],[-0.136667835223584,-0.139586127564204,-0.139670981202766,-0.131629815245003,-0.133594369998168,-0.135919106184737,-0.13396169462483,-0.138198726552408],null,null,null,{"interactive":true,"draggable":false,"keyboard":true,"title":"","alt":"","zIndexOffset":0,"opacity":1,"riseOnHover":false,"riseOffset":250},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]}],"limits":{"lat":[51.5100193414476,51.5158344857054],"lng":[-0.140073770024927,-0.131629815245003]}},"evals":[],"jsHooks":[]}</script>

---

Let's leave leaflet now, and do some **spatial analysis**!

.center[&lt;img src="https://media.giphy.com/media/chzz1FQgqhytWRWbp3/giphy.gif" style="width: 75%" /&gt;]

---

## Visualising sf with ggplot2 and geom_sf

Visualising your features is relatively simple using ggplot2. As simple as...


```r
ggplot() +
  geom_sf(data = Cholera_Deaths, colour = 'blue') +
  geom_sf(data = Pumps, colour = 'orange')
```

&lt;img src="r-analysing-spatial-data_files/figure-html/unnamed-chunk-13-1.svg" width="45%" style="display: block; margin: auto;" /&gt;

---

## Visualising sf with ggplot2 and geom_sf

`geom_sf()` will draw different geometric objects - points, lines, or polygons - depending on the type of your sf. `geom_sf()` adds `coord_sf()`. You can use `coord_sf()` for zooming in into your map. 


```r
ggplot() +
  geom_sf(data = Cholera_Deaths, colour = 'blue') +
  geom_sf(data = Pumps, colour = 'orange') +
  coord_sf(xlim = c(529209.9, 529606.3), 
           ylim = c(180902.7, 181261.4))
```

.pull-left[

&lt;img src="r-analysing-spatial-data_files/figure-html/unnamed-chunk-15-1.svg" width="55%" style="display: block; margin: auto;" /&gt;

  
]

.pull.right[

&lt;img src="r-analysing-spatial-data_files/figure-html/unnamed-chunk-16-1.svg" width="30%" style="display: block; margin: auto;" /&gt;

]

Visualising a simple map is straightforward, making it exactly as you want of course require time!  

---

## Computing cases within distance from each pump 

A simple visual analysis of the maps we have created so far is probably sufficient for suspecting a connection between cholera deaths and the water pump in Broadwick Street (formerly Broad Street). But let's say we want to somehow formalise this by calculating the number of deaths within a 150 meter radius from each pump. 

This is what we need to do:

1. Create an circular area centered on each pump;

2. Intersect cases (point) with areas (polygons);

3. Count how many deaths within each area. 

---

### Create an circular area with a radius of 150 m centered on each pump


```r
Pumps.buffer &lt;- 
  Pumps %&gt;%
* st_buffer(150)

ggplot() +
  geom_sf(data = Cholera_Deaths, colour = 'blue') +
  geom_sf(data = Pumps, colour = 'orange') +
  geom_sf(data = Pumps.buffer, colour = 'orange', alpha = .5)
```

&lt;img src="r-analysing-spatial-data_files/figure-html/unnamed-chunk-17-1.svg" width="45%" style="display: block; margin: auto;" /&gt;

---

### Create an circular area with a radius of 150 m centered on each pump

We are lucky that the unit of the CRS of `Pumps` (OSGB36 or EPSG:27700) is the meter. Other CRS have different units. For example, the unit of EPSG:4326 is the degree - so calculating distances or areas in meters requires a transformation.   

---

### Counting how many deaths within each area

Let's create a `matrix` with one row for each record in `Cholera_Deaths` and one column for each pump. 


```r
m &lt;- 
  matrix(nrow = nrow(Cholera_Deaths), ncol = nrow(Pumps.buffer))

dim(m)
```

```
## [1] 250   8
```

```r
head(m)
```

```
##      [,1] [,2] [,3] [,4] [,5] [,6] [,7] [,8]
## [1,]   NA   NA   NA   NA   NA   NA   NA   NA
## [2,]   NA   NA   NA   NA   NA   NA   NA   NA
## [3,]   NA   NA   NA   NA   NA   NA   NA   NA
## [4,]   NA   NA   NA   NA   NA   NA   NA   NA
## [5,]   NA   NA   NA   NA   NA   NA   NA   NA
## [6,]   NA   NA   NA   NA   NA   NA   NA   NA
```

---

#### Intersecting points with polygons

Then in a for-loop, we geographically intersect with (`st_intersect`) each point (`Cholera_Deaths`) with alternatively with different pump...


```r
for (j in 1:nrow(Pumps.buffer)) {
  
  m[,j] &lt;- 
    lengths(
      st_intersects(x = Cholera_Deaths, 
*                   y = Pumps.buffer[j,])
      ) &gt; 0

}
```

`st_intersects()` returns a list where for each feature in `x` (points, lines or polygons) it indicates the indices of the intersecting `y` features. 

But our `y` contains only a single feature (we are considering a single pump for each iteration of the for-loop). So if the length of the vector containing the indices of the intersecting feature will be `0` if `x`-`y` do not intersect while `&gt;0` (i.e. `1`) if they do intersect. 

---

#### Intersecting points with polygons

This is what our `matrix` `m` now looks like, with all the results...


```r
head(m)
```

```
##      [,1]  [,2]  [,3]  [,4]  [,5]  [,6]  [,7]  [,8]
## [1,] TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
## [2,] TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
## [3,] TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
## [4,] TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
## [5,] TRUE  TRUE FALSE FALSE FALSE FALSE FALSE FALSE
## [6,] TRUE FALSE FALSE FALSE FALSE FALSE FALSE FALSE
```


Note that by design a single record from `Cholera_Deaths` can intersect with more than one pump. But this is of course clear in the previous visualisations. Our buffers do partially overlap.

---

#### Intersecting points with polygons

Let's now visualise which records intersect with each pump.

First, we want to create a base map, `base_map` visualising all the records in the data set. 


```r
base_map &lt;-
  ggplot()  +
  geom_sf(data = Pumps.buffer, 
          colour = 'lightgray', alpha = .2) +
  geom_sf(data = Cholera_Deaths,
          colour = 'lightgray')
```

Conveniently, `base_map` can be add as firt layer in other spational visualisations.


---


```r
base_map
```

&lt;img src="r-analysing-spatial-data_files/figure-html/unnamed-chunk-22-1.svg" width="100%" style="display: block; margin: auto;" /&gt;

---

#### Intersecting points with polygons

An now we add to `base_map` the record intersecting with the first pump (`Pumps.buffer[1,]`) and with the second (`Pumps.buffer[2,]`).


```r
base_map +
  geom_sf(data = Cholera_Deaths[m[,1],], 
          colour = 'blue') +
  geom_sf(data = Pumps.buffer[1,], 
          colour = 'orange', alpha = .5),
```

&lt;img src="r-analysing-spatial-data_files/figure-html/unnamed-chunk-24-1.svg" width="100%" style="display: block; margin: auto;" /&gt;

---

## Counting how many deaths within each area

Now that we have all the results, we can associate the number of deaths to each pump.

Let's first create a new variable `Count` where to store that information (while initially setting the `Count` to `NA`).


```r
Pumps$Count &lt;- NA
```

Then we can again loop over each pump and make the sum of cases, and finally compute the percentage of all cases reported.


```r
for (i in 1:nrow(Pumps)) {
  
  Pumps$Count[i] &lt;-
*   sum(Cholera_Deaths$Count[m[,i]])
  
}
  
*Pumps$perc &lt;- Pumps$Count / sum(Cholera_Deaths$Count)
```

---

## Counting how many deaths within each area


| Id|geometry                  | Count|      perc|
|--:|:-------------------------|-----:|---------:|
|  0|POINT (529396.5 181025.1) |   335| 0.6850716|
|  0|POINT (529192.5 181079.4) |    97| 0.1983640|
|  0|POINT (529183.7 181193.7) |    20| 0.0408998|
|  0|POINT (529748.9 180924.2) |     4| 0.0081800|
|  0|POINT (529613.2 180896.8) |    61| 0.1247444|
|  0|POINT (529453.6 180826.4) |    77| 0.1574642|
|  0|POINT (529593.7 180660.5) |     0| 0.0000000|
|  0|POINT (529296.1 180794.8) |    21| 0.0429448|

We can now conclude that **68.5%** of all cases reported were located within 150 meters of the same pump. 

---

## Counting how many deaths within each area


```r
leaflet(Pumps %&gt;%
                   sf::st_transform(4326)) %&gt;% 
  addProviderTiles(providers$Stamen.TonerLite) %&gt;%
  addMarkers() %&gt;%
  addCircles(radius = ~sqrt(perc) * 200)
```

<div class="leaflet html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-028dd134ac33cab69ee2" style="width:100%;height:350px;"></div>
<script type="application/json" data-for="htmlwidget-028dd134ac33cab69ee2">{"x":{"options":{"crs":{"crsClass":"L.CRS.EPSG3857","code":null,"proj4def":null,"projectedBounds":null,"options":{}}},"calls":[{"method":"addProviderTiles","args":["Stamen.TonerLite",null,null,{"errorTileUrl":"","noWrap":false,"detectRetina":false}]},{"method":"addMarkers","args":[[51.5133411105774,51.5138759843636,51.5149055660644,51.512354016928,51.5121388725016,51.5115423119947,51.5100193414476,51.5112952195827],[-0.136667835223584,-0.139586127564204,-0.139670981202766,-0.131629815245003,-0.133594369998168,-0.135919106184737,-0.13396169462483,-0.138198726552408],null,null,null,{"interactive":true,"draggable":false,"keyboard":true,"title":"","alt":"","zIndexOffset":0,"opacity":1,"riseOnHover":false,"riseOffset":250},null,null,null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null]},{"method":"addCircles","args":[[51.5133411105774,51.5138759843636,51.5149055660644,51.512354016928,51.5121388725016,51.5115423119947,51.5100193414476,51.5112952195827],[-0.136667835223584,-0.139586127564204,-0.139670981202766,-0.131629815245003,-0.133594369998168,-0.135919106184737,-0.13396169462483,-0.138198726552408],[165.538101311103,89.0761490366437,40.4473957139505,18.0886252658454,70.6383398100829,79.3635212623373,0,41.4462472492136],null,null,{"interactive":true,"className":"","stroke":true,"color":"#03F","weight":5,"opacity":0.5,"fill":true,"fillColor":"#03F","fillOpacity":0.2},null,null,null,{"interactive":false,"permanent":false,"direction":"auto","opacity":1,"offset":[0,0],"textsize":"10px","textOnly":false,"className":"","sticky":true},null,null]}],"limits":{"lat":[51.5100193414476,51.5149055660644],"lng":[-0.139670981202766,-0.131629815245003]}},"evals":[],"jsHooks":[]}</script>


---








    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
